name: Check on Push

on: [push, pull_request, workflow_dispatch]

jobs:
  compile-test:
    name: "ðŸ›  Compile & Test"
    runs-on: self-hosted
    steps:
    - name: ðŸ›Ž Checkout
      uses: actions/checkout@v2
    - name: ðŸ›  Install bloat
      run: npm i 
    - name: ðŸ›  Compile typescript
      run: tsc 
  deploy: 
    name: "Deploy on xnet-sakura"
    needs: ["compile-test"]
    runs-on: self-hosted
    steps:
    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
        if_key_exists: "replace"
    - name: SSH Into xnet-sakura
      run: ssh ${{secrets.SSH_USER}}@${{secrets.SSH_HOST}}
    - name: Switch user
      run: sudo su geoxor
    - name: Go into the right folder
      run: cd /home/geoxor/backend
    - name: git pull
      run: Pull updates
    - name: Build the new backend
      run: docker build -t xornet-backend .
    - name: Restart containers
      run: docker-compose restart -d
